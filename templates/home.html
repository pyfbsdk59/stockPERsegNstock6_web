{% extends 'base.html' %}

{% block content %}
<style>
    /* æ‰‹æ©Ÿå„ªåŒ– CSS */
    .table-sm td, .table-sm th { padding: 0.3rem; font-size: 0.9rem; }
    .nav-tabs .nav-link { color: #495057; }
    .nav-tabs .nav-link.active { background-color: #0d6efd; color: white !important; font-weight: bold; border-color: #0d6efd; }
    .stat-card { transition: all 0.2s; border-left: 4px solid transparent; }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    .card-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
    .input-group-text { background-color: #e9ecef; width: 45px; justify-content: center; }
    .note-box { border-left: 4px solid #ffc107; background-color: #fff3cd; }
</style>

<div class="row mb-4 g-3">
    <div class="col-lg-6">
        <div class="card card-shadow h-100">
            <div class="card-body">
                <h6 class="card-title text-primary fw-bold mb-3">ğŸ” æŸ¥è©¢è‚¡ç¥¨</h6>
                <form method="post" class="row g-2 align-items-center">
                    {% csrf_token %}
                    <div class="col-3">
                        <select name="year" class="form-select form-select-sm">
                            {% for y in years %}<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-3">
                        <select name="month" class="form-select form-select-sm">
                            {% for m in months %}<option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m }}æœˆ</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-4">
                        <input type="text" name="stock_id" class="form-control form-select-sm" placeholder="ä»£ç¢¼" value="{{ selected_id|default:'' }}" required>
                    </div>
                    <div class="col-2"><button type="submit" name="search_stock" class="btn btn-primary btn-sm w-100">Go</button></div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card card-shadow h-100">
            <div class="card-body">
                <h6 class="card-title text-success fw-bold mb-3">ğŸ“‚ ä¸Šå‚³æ•¸æ“š (JSON)</h6>
                <form method="post" enctype="multipart/form-data" class="row g-2 align-items-center">
                    {% csrf_token %}
                    <div class="col-9"><input type="file" name="upload_json" class="form-control form-control-sm" accept=".json" required></div>
                    <div class="col-3"><button type="submit" name="upload_json" class="btn btn-success btn-sm w-100">ä¸Šå‚³</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm">{{ message|safe }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    {% endfor %}
{% endif %}

{% if result %}
{% with per=result.PER_Analysis six=result.Six_Indicators meta=result.Meta %}
<div class="card card-shadow mb-5">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-wrap">
        <h4 class="mb-0 fw-bold text-dark"><span class="badge bg-primary me-2">{{ meta.StockID }}</span>{{ per.Name }}</h4>
        <small class="text-muted mt-2 mt-md-0">åŸºæº–æ—¥: {{ meta.QueryDate }} ({{ meta.TargetMonth }}æœˆ)</small>
    </div>
    
    <div class="card-body p-4">
        
        <div class="row g-3 mb-4 text-center">
            <div class="col-6 col-md-2"><div class="p-2 border rounded bg-light stat-card" style="border-left-color: #0d6efd !important;"><small class="text-muted d-block mb-1">æœ€æ–°æˆäº¤</small><span class="fs-5 fw-bold">{{ per.Now_Price }}</span></div></div>
            <div class="col-6 col-md-2"><div class="p-2 border rounded bg-light stat-card"><small class="text-muted d-block mb-1">é ä¼°ç‡Ÿæ”¶</small><span class="fs-5">{{ per.Predict_Rev }}</span></div></div>
            <div class="col-6 col-md-2"><div class="p-2 border rounded bg-light stat-card" style="border-left-color: #dc3545 !important;"><small class="text-muted d-block mb-1">é ä¼°EPS(26)</small><span class="fs-4 text-danger fw-bold">{{ per.Predict_EPS }}</span></div></div>
            <div class="col-6 col-md-2"><div class="p-2 border rounded bg-light stat-card"><small class="text-muted d-block mb-1">ç›®æ¨™åƒ¹(é«˜)</small><span class="fs-5 text-success fw-bold">{{ per.Target_H }}</span></div></div>
            <div class="col-6 col-md-2"><div class="p-2 border rounded bg-light stat-card"><small class="text-muted d-block mb-1">ç›®æ¨™åƒ¹(ä½)</small><span class="fs-5 text-secondary fw-bold">{{ per.Target_L }}</span></div></div>
            <div class="col-6 col-md-2"><div class="p-2 border rounded bg-light stat-card"><small class="text-muted d-block mb-1">æ½›åœ¨å ±é…¬</small><span class="fs-5 text-danger fw-bold">{{ per.Profit }}</span></div></div>
        </div>

        <ul class="nav nav-tabs nav-fill mb-4" id="stockTabs" role="tablist">
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sim">ğŸ§ª æ¨¡æ“¬è©¦ç®—</button></li>
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-hist">æ­·å²è‚¡åƒ¹</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rev">ç‡Ÿæ”¶</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-net">æ·¨åˆ©</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-six">å…­å¤§æŒ‡æ¨™</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-q4">Q4 æª¢æŸ¥</button></li>
        </ul>

        <div class="tab-content" id="stockTabsContent">
            
            <div class="tab-pane fade" id="tab-sim">
                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body">
                                <h5 class="card-title text-secondary fw-bold mb-3 border-bottom pb-2">ğŸ“Š åŸå§‹é ä¼° (JSON)</h5>
                                <ul class="list-group list-group-flush bg-transparent mb-3">
                                    <li class="list-group-item bg-transparent d-flex justify-content-between px-0"><span>é ä¼° EPS (2026)</span><strong class="text-dark">{{ per.Predict_EPS }}</strong></li>
                                    <li class="list-group-item bg-transparent d-flex justify-content-between px-0"><span>åŸå§‹é ä¼°ç‡Ÿæ”¶</span><strong>{{ per.Predict_Rev }} å„„</strong></li>
                                    <li class="list-group-item bg-transparent d-flex justify-content-between px-0"><span>åŸå§‹ç‡Ÿæ”¶å¹´å¢ç‡</span><strong>{{ per.YoY_Use }}</strong></li>
                                    <li class="list-group-item bg-transparent d-flex justify-content-between px-0"><span>å¹³å‡æ·¨åˆ©ç‡</span><strong>{{ per.Net_Avg }}</strong></li>
                                    <li class="list-group-item bg-transparent d-flex justify-content-between px-0"><span>è‚¡æœ¬</span><strong>{{ per.Capital }} å„„</strong></li>
                                </ul>

                                <div class="p-3 rounded note-box">
                                    <h6 class="fw-bold text-dark border-bottom border-warning pb-2 mb-2">ğŸ’¡ å…©è€…å·®ç•°èªªæ˜</h6>
                                    <p class="small text-muted mb-2">
                                        <strong>åŸå§‹é ä¼°ï¼š</strong> ä¾æ“šçˆ¬èŸ²ç•¶ä¸‹çš„ç‡Ÿæ”¶è¶¨å‹¢æ¨ç®—ï¼Œæ•¸å€¼å›ºå®šã€‚
                                    </p>
                                    <p class="small text-muted mb-0">
                                        <strong>æ¨¡æ“¬è¨ˆç®—ï¼š</strong> 
                                        ç¨‹å¼æœƒå…ˆåæ¨ã€Œå»å¹´åŸºæœŸç‡Ÿæ”¶ã€ï¼Œå†ä¾æ“šæ‚¨è¼¸å…¥çš„ <span class="text-primary fw-bold">ç‡Ÿæ”¶å¹´å¢ç‡</span> èˆ‡ <span class="text-primary fw-bold">æ·¨åˆ©ç‡</span> é‡æ–°è¨ˆç®— EPSã€‚
                                        <br>
                                        <em>å…¬å¼ï¼š(åŸºæœŸç‡Ÿæ”¶ Ã— æ–°æˆé•·ç‡ Ã— æ–°æ·¨åˆ©ç‡) Ã· è‚¡æœ¬</em>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card border-primary shadow-sm">
                            <div class="card-header bg-primary text-white fw-bold">âœï¸ æ‰‹å‹•èª¿æ•´åƒæ•¸ (é€£å‹•è¨ˆç®—)</div>
                            <div class="card-body">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="stock_id" value="{{ result.Meta.StockID }}">
                                    <input type="hidden" name="year" value="{{ selected_year }}">
                                    <input type="hidden" name="month" value="{{ selected_month }}">
                                    <input type="hidden" name="calc_simulation" value="1">

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">ç‡Ÿæ”¶å¹´å¢ç‡ (%)</label>
                                            <div class="input-group">
                                                <input type="number" step="any" name="sim_yoy" class="form-control" 
                                                       value="{{ sim_res.display_yoy|default:per.YoY_Use|cut:'%' }}" placeholder="ä¾‹å¦‚ 15">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">ç¨…å¾Œæ·¨åˆ©ç‡ (%)</label>
                                            <div class="input-group">
                                                <input type="number" step="any" name="sim_net" class="form-control" 
                                                       value="{{ sim_res.display_net|default:per.Net_Avg|cut:'%' }}" placeholder="ä¾‹å¦‚ 20">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">æœ¬ç›Šæ¯” (é«˜)</label>
                                            <input type="number" step="any" name="sim_pe_h" class="form-control" 
                                                   value="{{ sim_res.pe_h|default:per.PE_Use_H }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">æœ¬ç›Šæ¯” (ä½)</label>
                                            <input type="number" step="any" name="sim_pe_l" class="form-control" 
                                                   value="{{ sim_res.pe_l|default:per.PE_Use_L }}">
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary w-100 fw-bold shadow-sm">
                                        ğŸ”„ åŸ·è¡Œæ¨¡æ“¬è©¦ç®— (é€£å‹• EPS)
                                    </button>
                                </form>

                                {% if sim_res %}
                                <div class="mt-4 pt-3 border-top animate__animated animate__fadeIn">
                                    <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                                        <span>æ¨¡æ“¬ EPS (2026)</span>
                                        <span class="h3 mb-0 fw-bold text-primary">{{ sim_res.calc_eps }}</span>
                                    </div>
                                    
                                    <div class="row text-center mb-3">
                                        <div class="col-4 border-end">
                                            <small class="text-muted">ç›®æ¨™åƒ¹(é«˜)</small>
                                            <div class="fw-bold text-success">{{ sim_res.target_h }}</div>
                                            <small class="text-success">{{ sim_res.upside }}</small>
                                        </div>
                                        <div class="col-4 border-end">
                                            <small class="text-muted">å³æ™‚åƒ¹</small>
                                            <div class="fw-bold text-dark">{{ sim_res.live_price }}</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">ç›®æ¨™åƒ¹(ä½)</small>
                                            <div class="fw-bold text-danger">{{ sim_res.target_l }}</div>
                                            <small class="text-danger">{{ sim_res.downside }}</small>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <span class="badge bg-dark rounded-pill px-3">é¢¨éšªå ±é…¬æ¯” (RR): {{ sim_res.rr }}</span>
                                    </div>

                                    <div class="accordion" id="calcAccordion">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header" id="headingOne">
                                                <button class="accordion-button collapsed bg-light py-2 text-muted small" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                                    ğŸ‘ï¸ æŸ¥çœ‹è©³ç´°è¨ˆç®—éç¨‹ (é©—è­‰ç”¨)
                                                </button>
                                            </h2>
                                            <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#calcAccordion">
                                                <div class="accordion-body p-0">
                                                    <table class="table table-sm table-bordered mb-0 small">
                                                        <thead class="table-light"><tr><th>æ­¥é©Ÿ</th><th>ç®—å¼</th><th>çµæœ</th></tr></thead>
                                                        <tbody>
                                                            {% for row in sim_res.details %}
                                                            <tr>
                                                                <td>{{ row.step }}</td>
                                                                <td class="text-muted font-monospace">{{ row.formula }}</td>
                                                                <td class="fw-bold">{{ row.result }}</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade show active" id="tab-hist">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped text-center align-middle">
                        <thead class="table-dark"><tr><th>å¹´ä»½</th><th>æœ€é«˜</th><th>æœ€ä½</th><th>EPS</th><th>PE é«˜</th><th>PE ä½</th></tr></thead>
                        <tbody>
                            <tr class="table-warning fw-bold">
                                <td>{{ per.Current_Year }}/{{ per.Current_Year_ROC }}(é ä¼°)</td>
                                <td class="text-danger">{{ per.Target_H }}</td><td class="text-success">{{ per.Target_L }}</td>
                                <td class="text-primary">{{ per.Predict_EPS }}</td><td>-</td><td>-</td>
                            </tr>
                            {% for row in hist_rows %}
                            <tr>
                                <td>{{ row.year_str }}{% if forloop.first and per.EPS1_Is_Est %}(é ){% endif %}</td>
                                <td>{{ row.h }}</td><td>{{ row.l }}</td><td>{{ row.eps }}</td><td>{{ row.pe_h }}</td><td>{{ row.pe_l }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-rev">
                <div class="row"><div class="col-md-8 mx-auto"><table class="table table-sm table-bordered text-center"><thead class="bg-light"><tr><th>æœˆä»½</th><th>ç‡Ÿæ”¶(å„„)</th><th>å¹´å¢ç‡</th></tr></thead><tbody>{% for row in rev_rows %}<tr><td>{{ row.name }}</td><td>{{ row.val }}</td><td>-</td></tr>{% endfor %}<tr class="table-secondary"><td>---</td><td></td><td></td></tr>{% for row in yoy_rows %}<tr><td>{{ row.name }}</td><td>-</td><td class="{% if '-' in row.yoy %}text-success{% else %}text-danger{% endif %}">{{ row.yoy }}</td></tr>{% endfor %}</tbody></table></div></div>
            </div>

            <div class="tab-pane fade" id="tab-net">
                <div class="row"><div class="col-md-6 mx-auto"><table class="table table-bordered text-center"><thead class="bg-light"><tr><th>å­£åº¦</th><th>æ·¨åˆ©ç‡</th></tr></thead><tbody>{% for row in net_rows %}<tr><td>{{ row.name }}</td><td>{{ row.val }}</td></tr>{% endfor %}</tbody></table></div></div>
            </div>

            <div class="tab-pane fade" id="tab-six">
                <div class="alert alert-info text-center mb-3"><strong>ğŸ† ç¸½è©•åˆ†ï¼š</strong> <span class="fs-4 fw-bold text-danger">{{ six.Average }}</span> åˆ†</div>
                <div class="row g-3">
                    {% for key, item in six.items %}{% if key != 'Name' and key != 'Average' %}
                    <div class="col-md-4 col-sm-6"><div class="card h-100 card-shadow"><div class="card-header d-flex justify-content-between small"><strong>{{ key }}</strong><span class="badge {% if item.Rating == 'A' or item.Rating == 'AA' %}bg-danger{% else %}bg-secondary{% endif %}">{{ item.Rating }}</span></div><div class="card-body p-0"><table class="table table-sm table-striped mb-0 text-center"><thead><tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr></thead><tbody>{% for d in item.Data %}<tr><td>{{ d.Name }}</td><td>{{ d.Val }}</td></tr>{% endfor %}</tbody></table></div></div></div>
                    {% endif %}{% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="tab-q4">
                <div class="row"><div class="col-md-8 mx-auto"><table class="table table-bordered table-hover"><thead class="table-dark"><tr><th>é …ç›®</th><th>æ•¸å€¼/ç‹€æ…‹</th></tr></thead><tbody>{% for row in q4_rows %}<tr><td class="fw-bold">{{ row.0 }}</td><td>{{ row.1 }}</td></tr>{% endfor %}</tbody></table></div></div>
            </div>

        </div>
    </div>
</div>
{% endwith %}
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // å¦‚æœæœ‰é€²è¡Œæ¨¡æ“¬è©¦ç®—ï¼Œè‡ªå‹•åˆ‡æ›åˆ°è©² Tab
        {% if sim_res %}
            var triggerEl = document.querySelector('button[data-bs-target="#tab-sim"]');
            var tab = new bootstrap.Tab(triggerEl);
            tab.show();
        {% endif %}
    });
</script>

{% endblock %}