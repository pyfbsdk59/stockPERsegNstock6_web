{% extends 'base.html' %}

{% block content %}
<style>
    .table-sm td, .table-sm th { padding: 0.25rem; }
    .nav-tabs .nav-link.active { background-color: #e7f1ff; color: #0d6efd; font-weight: bold; }
    .card-header { background-color: #f8f9fa; }
    .stat-box { transition: transform 0.2s; }
    .stat-box:hover { transform: translateY(-3px); }
</style>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <form method="post" class="row g-2 w-100">
                    {% csrf_token %}
 <div class="col-3">
    <select name="year" class="form-select">
        {% for y in years %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
    </select>
</div>
<div class="col-3">
    <select name="month" class="form-select">
        {% for m in months %}
            <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m }}Êúà</option>
        {% endfor %}
    </select>
</div>
                    <div class="col-4">
                        <input type="text" name="stock_id" class="form-control" placeholder="‰ª£Ëôü (e.g. 2330)" value="{{ selected_id|default:'' }}" required>
                    </div>
                    <div class="col-2">
                        <button type="submit" name="search_stock" class="btn btn-primary w-100">Go</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm h-100 border-success">
            <div class="card-body d-flex align-items-center justify-content-between">
                <span class="fw-bold text-success">üìÇ ÂåØÂÖ• JSON Êï∏Êìö</span>
                <form method="post" enctype="multipart/form-data" class="d-flex">
                    {% csrf_token %}
                    <input type="file" name="upload_json" class="form-control me-2" accept=".json" required>
                    <button type="submit" class="btn btn-success">‰∏äÂÇ≥</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    {% endfor %}
{% endif %}

{% if result %}
{% with per=result.PER_Analysis six=result.Six_Indicators meta=result.Meta %}
<div class="card shadow mb-5">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold">{{ per.Name }} ({{ meta.StockID }})</h4>
        <div>
            <span class="badge bg-light text-dark me-2">Êü•Ë©¢Êó•: {{ meta.QueryDate }}</span>
            <span class="badge bg-warning text-dark">Âü∫Ê∫ñÊúà: {{ meta.TargetMonth }}</span>
        </div>
    </div>
    
    <div class="card-body">
        
        <div class="row text-center mb-4 g-3">
            <div class="col-md-2">
                <div class="p-2 border rounded bg-light stat-box">
                    <small class="text-muted">ÊúÄÊñ∞Êàê‰∫§ÂÉπ</small>
                    <div class="fs-5 fw-bold">{{ per.Now_Price }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-2 border rounded bg-light stat-box">
                    <small class="text-muted">È†ê‰º∞ÁáüÊî∂</small>
                    <div class="fs-5">{{ per.Predict_Rev }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-2 border rounded bg-light stat-box">
                    <small class="text-muted">È†ê‰º∞ EPS (2026)</small>
                    <div class="fs-4 text-danger fw-bold">{{ per.Predict_EPS }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-2 border rounded bg-light stat-box">
                    <small class="text-muted">ÁõÆÊ®ôÂÉπ (È´ò)</small>
                    <div class="fs-5 text-success fw-bold">{{ per.Target_H }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-2 border rounded bg-light stat-box">
                    <small class="text-muted">ÁõÆÊ®ôÂÉπ (‰Ωé)</small>
                    <div class="fs-5 text-secondary fw-bold">{{ per.Target_L }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="p-2 border rounded bg-light stat-box">
                    <small class="text-muted">ÊΩõÂú®Â†±ÈÖ¨</small>
                    <div class="fs-5 text-danger fw-bold">{{ per.Profit }}</div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="stockTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-hist">Ê≠∑Âè≤ËÇ°ÂÉπ</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rev">ÁáüÊî∂ÂàÜÊûê</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-net">Ê∑®Âà©Ë≥áÊñô</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-six">ÂÖ≠Â§ßÊåáÊ®ô(Ë©≥Á¥∞)</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-q4">Q4 È†êÊ∏¨Ê™¢Êü•</button></li>
        </ul>

        <div class="tab-content" id="stockTabsContent">
            
            <div class="tab-pane fade show active" id="tab-hist">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped text-center table-hover">
                        <thead class="table-dark">
                            <tr><th>Âπ¥‰ªΩ</th><th>ÊúÄÈ´ò</th><th>ÊúÄ‰Ωé</th><th>EPS</th><th>PE È´ò</th><th>PE ‰Ωé</th></tr>
                        </thead>
                        <tbody>
                            <tr class="table-warning fw-bold">
                                <td>{{ per.Current_Year }}/{{ per.Current_Year_ROC }}(È†ê‰º∞)</td>
                                <td class="text-danger">{{ per.Target_H }}</td>
                                <td class="text-success">{{ per.Target_L }}</td>
                                <td class="text-primary">{{ per.Predict_EPS }}</td>
                                <td>-</td><td>-</td>
                            </tr>
                            {% for row in hist_rows %}
                            <tr>
                                <td>{{ row.year_str }}{% if forloop.first and per.EPS1_Is_Est %}(È†ê){% endif %}</td>
                                <td>{{ row.h }}</td>
                                <td>{{ row.l }}</td>
                                <td>{{ row.eps }}</td>
                                <td>{{ row.pe_h }}</td>
                                <td>{{ row.pe_l }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="table-info">
                                <td>Âπ≥Âùá PE</td><td>-</td><td>-</td><td>-</td><td>{{ per.PE_Avg_H }}</td><td>{{ per.PE_Avg_L }}</td>
                            </tr>
                            <tr class="table-light fw-bold">
                                <td>Êé°Áî® PE</td><td>-</td><td>-</td><td>-</td><td>{{ per.PE_Use_H }}</td><td>{{ per.PE_Use_L }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-rev">
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <table class="table table-sm table-bordered text-center">
                            <thead class="bg-light"><tr><th>Êúà‰ªΩ</th><th>ÁáüÊî∂(ÂÑÑ)</th><th>Âπ¥Â¢ûÁéá</th></tr></thead>
                            <tbody>
                                {% for row in rev_rows %}
                                <tr><td>{{ row.name }}</td><td>{{ row.val }}</td><td>-</td></tr>
                                {% endfor %}
                                <tr class="table-secondary"><td>---</td><td></td><td></td></tr>
                                {% for row in yoy_rows %}
                                <tr><td>{{ row.name }}</td><td>-</td><td class="{% if '-' in row.yoy %}text-success{% else %}text-danger{% endif %}">{{ row.yoy }}</td></tr>
                                {% endfor %}
                                <tr class="table-warning fw-bold">
                                    <td>Âπ≥Âùá/ÈÅ∏Áî®</td><td>-</td><td>{{ per.YoY_Avg }} / {{ per.YoY_Use }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-net">
                <div class="col-md-6 mx-auto">
                    <table class="table table-bordered text-center">
                        <thead class="bg-light"><tr><th>Â≠£Â∫¶</th><th>Ê∑®Âà©Áéá</th></tr></thead>
                        <tbody>
                            {% for row in net_rows %}
                            <tr><td>{{ row.name }}</td><td>{{ row.val }}</td></tr>
                            {% endfor %}
                            <tr class="table-warning fw-bold"><td>Âπ≥Âùá</td><td>{{ per.Net_Avg }}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-six">
                <div class="alert alert-info text-center mb-3">
                    <strong>üèÜ Á∏ΩË©ïÂàÜÔºö</strong> <span class="fs-4 fw-bold text-danger">{{ six.Average }}</span> ÂàÜ
                </div>
                <div class="row g-3">
                    {% for key, item in six.items %}
                    {% if key != 'Name' and key != 'Average' %}
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between">
                                <strong>{{ key }}</strong>
                                <span class="badge {% if item.Rating == 'A' or item.Rating == 'AA' %}bg-danger{% else %}bg-secondary{% endif %}">{{ item.Rating }}</span>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-striped mb-0 text-center" style="font-size: 0.9em;">
                                    <thead><tr><th>È†ÖÁõÆ</th><th>Êï∏ÂÄº</th>{% if key == 'Net' %}<th>YoY</th>{% endif %}</tr></thead>
                                    <tbody>
                                        {% for d in item.Data %}
                                        <tr>
                                            <td>{{ d.Name }}</td>
                                            <td>{{ d.Val }}</td>
                                            {% if key == 'Net' %}<td>{{ d.YoY|default:"-" }}</td>{% endif %}
                                        </tr>
                                        {% endfor %}
                                        {% for k, v in item.Extra.items %}
                                        <tr class="table-secondary fw-bold"><td>{{ k }}</td><td colspan="2">{{ v }}</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="tab-q4">
                <div class="col-md-8 mx-auto">
                    <table class="table table-bordered table-hover">
                        <thead class="table-dark"><tr><th>È†ÖÁõÆ</th><th>Êï∏ÂÄº/ÁãÄÊÖã</th></tr></thead>
                        <tbody>
                            {% for row in q4_rows %}
                            <tr>
                                <td class="fw-bold">{{ row.0 }}</td>
                                <td>{{ row.1 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
{% endwith %}
{% endif %}
{% endblock %}