{% extends 'base.html' %}

{% block content %}
<style>
    .table-sm td, .table-sm th { padding: 0.25rem; }
    .nav-tabs .nav-link.active { background-color: #e7f1ff; color: #0d6efd; font-weight: bold; }
    .card-header { background-color: #f8f9fa; }
    .stat-box { transition: transform 0.2s; }
    .stat-box:hover { transform: translateY(-3px); }
</style>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">ğŸ” æŸ¥è©¢è‚¡ç¥¨</div>
            <div class="card-body">
                <form method="post" class="row g-2 align-items-center">
                    {% csrf_token %}
                    <div class="col-3">
                        <select name="year" class="form-select">
                            {% for y in years %}<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-3">
                        <select name="month" class="form-select">
                            {% for m in months %}<option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m }}æœˆ</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-4">
                        <input type="text" name="stock_id" class="form-control" placeholder="ä»£ç¢¼" value="{{ selected_id|default:'' }}" required>
                    </div>
                    <div class="col-2"><button type="submit" name="search_stock" class="btn btn-primary w-100">Go</button></div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm h-100 border-success">
            <div class="card-header bg-success text-white fw-bold">ğŸ“‚ ä¸Šå‚³ JSON</div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" class="row g-2 align-items-center">
                    {% csrf_token %}
                    <div class="col-9"><input type="file" name="upload_json" class="form-control" accept=".json" required></div>
                    <div class="col-3"><button type="submit" name="upload_json" class="btn btn-success w-100">ä¸Šå‚³</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">{{ message|safe }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    {% endfor %}
{% endif %}

{% if result %}
{% with per=result.PER_Analysis six=result.Six_Indicators meta=result.Meta %}
<div class="card shadow mb-5">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold">{{ per.Name }} ({{ meta.StockID }})</h4>
        <div>
            <span class="badge bg-light text-dark me-2">æŸ¥è©¢: {{ meta.QueryDate }}</span>
            <span class="badge bg-warning text-dark">åŸºæº–: {{ meta.TargetMonth }}æœˆ</span>
        </div>
    </div>
    
    <div class="card-body">
        
        <div class="row text-center mb-4 g-3">
            <div class="col-md-2"><div class="p-2 border rounded bg-light stat-box"><small class="text-muted">æœ€æ–°æˆäº¤åƒ¹</small><div class="fs-5 fw-bold">{{ per.Now_Price }}</div></div></div>
            <div class="col-md-2"><div class="p-2 border rounded bg-light stat-box"><small class="text-muted">é ä¼°ç‡Ÿæ”¶</small><div class="fs-5">{{ per.Predict_Rev }}</div></div></div>
            <div class="col-md-2"><div class="p-2 border rounded bg-light stat-box"><small class="text-muted">é ä¼° EPS (2026)</small><div class="fs-4 text-danger fw-bold">{{ per.Predict_EPS }}</div></div></div>
            <div class="col-md-2"><div class="p-2 border rounded bg-light stat-box"><small class="text-muted">ç›®æ¨™åƒ¹ (é«˜)</small><div class="fs-5 text-success fw-bold">{{ per.Target_H }}</div></div></div>
            <div class="col-md-2"><div class="p-2 border rounded bg-light stat-box"><small class="text-muted">ç›®æ¨™åƒ¹ (ä½)</small><div class="fs-5 text-secondary fw-bold">{{ per.Target_L }}</div></div></div>
            <div class="col-md-2"><div class="p-2 border rounded bg-light stat-box"><small class="text-muted">æ½›åœ¨å ±é…¬</small><div class="fs-5 text-danger fw-bold">{{ per.Profit }}</div></div></div>
        </div>

        <ul class="nav nav-tabs mb-3" id="stockTabs" role="tablist">
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sim">ğŸ§ª æ¨¡æ“¬è©¦ç®—</button></li>
            
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-hist">æ­·å²è‚¡åƒ¹</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rev">ç‡Ÿæ”¶åˆ†æ</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-net">æ·¨åˆ©è³‡æ–™</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-six">å…­å¤§æŒ‡æ¨™</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-q4">Q4 æª¢æŸ¥</button></li>
        </ul>

        <div class="tab-content" id="stockTabsContent">
            
            <div class="tab-pane fade" id="tab-sim">
                <div class="row">
                    
                    <div class="col-md-6 border-end">
                        <h5 class="text-secondary mb-3">ğŸ“Š åŸå§‹é ä¼°æ•¸æ“š (JSON)</h5>
                        <ul class="list-group list-group-flush mb-4">
                            <li class="list-group-item d-flex justify-content-between"><span>æœ€æ–°é ä¼° EPS (2026)</span><strong>{{ per.Predict_EPS }}</strong></li>
                            <li class="list-group-item d-flex justify-content-between"><span>é ä¼°ç‡Ÿæ”¶å¹´å¢ç‡</span><strong>{{ per.YoY_Use }}</strong></li>
                            <li class="list-group-item d-flex justify-content-between"><span>å¹³å‡æ·¨åˆ©ç‡</span><strong>{{ per.Net_Avg }}</strong></li>
                            <li class="list-group-item d-flex justify-content-between"><span>æœ¬ç›Šæ¯”å€é–“ (é«˜)</span><strong>{{ per.PE_Use_H }}</strong></li>
                            <li class="list-group-item d-flex justify-content-between"><span>æœ¬ç›Šæ¯”å€é–“ (ä½)</span><strong>{{ per.PE_Use_L }}</strong></li>
                        </ul>
                        <div class="alert alert-secondary text-center">
                            åŸå§‹ç›®æ¨™åƒ¹ï¼š <strong>{{ per.Target_L }} ~ {{ per.Target_H }}</strong>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5 class="text-primary mb-3">âœï¸ æ‰‹å‹•èª¿æ•´åƒæ•¸ (çµåˆå³æ™‚è‚¡åƒ¹)</h5>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="stock_id" value="{{ result.Meta.StockID }}">
                            <input type="hidden" name="year" value="{{ selected_year }}">
                            <input type="hidden" name="month" value="{{ selected_month }}">
                            <input type="hidden" name="calc_simulation" value="1">

                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">é ä¼° EPS (2026)</label>
                                    <input type="number" step="0.01" name="sim_eps" class="form-control" value="{{ sim_res.eps|default:per.Predict_EPS }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">ç‡Ÿæ”¶å¹´å¢ç‡ (åƒè€ƒ)</label>
                                    <input type="text" name="sim_yoy" class="form-control" value="{{ sim_res.yoy|default:per.YoY_Use }}">
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">PE å€é–“ (é«˜)</label>
                                    <input type="number" step="0.01" name="sim_pe_h" class="form-control" value="{{ sim_res.pe_h|default:per.PE_Use_H }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">PE å€é–“ (ä½)</label>
                                    <input type="number" step="0.01" name="sim_pe_l" class="form-control" value="{{ sim_res.pe_l|default:per.PE_Use_L }}">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mt-3 shadow-sm">ğŸ”„ é‡æ–°è©¦ç®—</button>
                        </form>

                        {% if sim_res %}
                        <div class="mt-4 p-3 bg-light border rounded">
                            <h6 class="fw-bold text-center border-bottom pb-2">ğŸ¯ æ¨¡æ“¬çµæœ (å³æ™‚è‚¡åƒ¹: {{ sim_res.live_price }})</h6>
                            <div class="row text-center mt-3">
                                <div class="col-6">
                                    <small class="text-muted">æ–°ç›®æ¨™åƒ¹ (é«˜)</small>
                                    <div class="fs-4 text-success fw-bold">{{ sim_res.target_h }}</div>
                                    <div class="small text-success">{{ sim_res.upside }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">æ–°ç›®æ¨™åƒ¹ (ä½)</small>
                                    <div class="fs-4 text-danger fw-bold">{{ sim_res.target_l }}</div>
                                    <div class="small text-danger">{{ sim_res.downside }}</div>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <span class="badge bg-dark">é¢¨éšªå ±é…¬æ¯”: {{ sim_res.rr }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="tab-pane fade show active" id="tab-hist">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped text-center table-hover">
                        <thead class="table-dark"><tr><th>å¹´ä»½</th><th>æœ€é«˜</th><th>æœ€ä½</th><th>EPS</th><th>PE é«˜</th><th>PE ä½</th></tr></thead>
                        <tbody>
                            <tr class="table-warning fw-bold">
                                <td>{{ per.Current_Year }}/{{ per.Current_Year_ROC }}(é ä¼°)</td>
                                <td class="text-danger">{{ per.Target_H }}</td><td class="text-success">{{ per.Target_L }}</td>
                                <td class="text-primary">{{ per.Predict_EPS }}</td><td>-</td><td>-</td>
                            </tr>
                            {% for row in hist_rows %}
                            <tr>
                                <td>{{ row.year_str }}{% if forloop.first and per.EPS1_Is_Est %}(é ){% endif %}</td>
                                <td>{{ row.h }}</td><td>{{ row.l }}</td><td>{{ row.eps }}</td><td>{{ row.pe_h }}</td><td>{{ row.pe_l }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-rev">
                <div class="col-md-8 mx-auto"><table class="table table-sm table-bordered text-center"><thead class="bg-light"><tr><th>æœˆä»½</th><th>ç‡Ÿæ”¶(å„„)</th><th>å¹´å¢ç‡</th></tr></thead><tbody>{% for row in rev_rows %}<tr><td>{{ row.name }}</td><td>{{ row.val }}</td><td>-</td></tr>{% endfor %}<tr class="table-secondary"><td>---</td><td></td><td></td></tr>{% for row in yoy_rows %}<tr><td>{{ row.name }}</td><td>-</td><td class="{% if '-' in row.yoy %}text-success{% else %}text-danger{% endif %}">{{ row.yoy }}</td></tr>{% endfor %}</tbody></table></div>
            </div>

            <div class="tab-pane fade" id="tab-net">
                <div class="col-md-6 mx-auto"><table class="table table-bordered text-center"><thead class="bg-light"><tr><th>å­£åº¦</th><th>æ·¨åˆ©ç‡</th></tr></thead><tbody>{% for row in net_rows %}<tr><td>{{ row.name }}</td><td>{{ row.val }}</td></tr>{% endfor %}</tbody></table></div>
            </div>

            <div class="tab-pane fade" id="tab-six">
                <div class="alert alert-info text-center mb-3"><strong>ğŸ† ç¸½è©•åˆ†ï¼š</strong> <span class="fs-4 fw-bold text-danger">{{ six.Average }}</span> åˆ†</div>
                <div class="row g-3">{% for key, item in six.items %}{% if key != 'Name' and key != 'Average' %}<div class="col-md-4"><div class="card h-100"><div class="card-header d-flex justify-content-between"><strong>{{ key }}</strong><span class="badge {% if item.Rating == 'A' or item.Rating == 'AA' %}bg-danger{% else %}bg-secondary{% endif %}">{{ item.Rating }}</span></div><div class="card-body p-0"><table class="table table-sm table-striped mb-0 text-center"><thead><tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr></thead><tbody>{% for d in item.Data %}<tr><td>{{ d.Name }}</td><td>{{ d.Val }}</td></tr>{% endfor %}</tbody></table></div></div></div>{% endif %}{% endfor %}</div>
            </div>

            <div class="tab-pane fade" id="tab-q4">
                <div class="col-md-8 mx-auto"><table class="table table-bordered table-hover"><thead class="table-dark"><tr><th>é …ç›®</th><th>æ•¸å€¼/ç‹€æ…‹</th></tr></thead><tbody>{% for row in q4_rows %}<tr><td class="fw-bold">{{ row.0 }}</td><td>{{ row.1 }}</td></tr>{% endfor %}</tbody></table></div>
            </div>

        </div>
    </div>
</div>
{% endwith %}
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // å¦‚æœæœ‰é€²è¡Œæ¨¡æ“¬è©¦ç®—ï¼Œè‡ªå‹•åˆ‡æ›åˆ°è©² Tab
        {% if sim_res %}
            var triggerEl = document.querySelector('button[data-bs-target="#tab-sim"]');
            var tab = new bootstrap.Tab(triggerEl);
            tab.show();
        {% endif %}
    });
</script>

{% endblock %}